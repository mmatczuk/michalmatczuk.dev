<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>michalmatczuk.dev/posts/scylladb-manager-22-repair-revisited/</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/svg+xml href=/favicon.svg><meta property="og:title" content="ScyllaDB Manager 2.2: Repair Revisited"><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:url" content="https://michalmatczuk.dev/posts/scylladb-manager-22-repair-revisited/"><meta property="article:published_time" content="2020-11-12T00:00:00+00:00"><meta name=twitter:title content="ScyllaDB Manager 2.2: Repair Revisited"><meta name=twitter:description content="This blog post has been first published in ScyllaDB blog.
We released ScyllaDB Manager 1.0 to help our users manage repairs in February 2018. Since then a lot of things have changed. We added the row-level repair to ScyllaDB Open Source NoSQL Database, and to the Enterprise version this year. We just released ScyllaDB Manager 2.2 with a new repair method optimized for row-level repair.
New repair features in ScyllaDB Manager 2."><link rel=stylesheet href=https://michalmatczuk.dev/css/terminal.min.css><link rel=stylesheet href=https://michalmatczuk.dev/css/syntax.min.css><link rel=stylesheet href=https://michalmatczuk.dev/css/overwrite.css><link rel=stylesheet href=https://michalmatczuk.dev/css/normalize.min.css><link rel=stylesheet href=https://michalmatczuk.dev/css/fontawesome.min.css><link rel=stylesheet href=https://michalmatczuk.dev/css/brands.min.css><link rel=stylesheet href=https://michalmatczuk.dev/css/solid.min.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-EG92897MK2"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-EG92897MK2")</script></head><body class=terminal><div class=container><div class=terminal-nav><header class=terminal-logo><div class="logo terminal-prompt"><a href=https://michalmatczuk.dev class=no-style>michalmatczuk.dev</a>:~#
<a href=https://michalmatczuk.dev/posts>posts</a>/</div></header><nav class=terminal-menu><ul vocab="https://schema.org/" typeof="BreadcrumbList"><li><a href=https://michalmatczuk.dev/posts/ typeof="ListItem">posts/</a></li><li><a href=https://michalmatczuk.dev/talks/ typeof="ListItem">talks/</a></li><li><a href=https://michalmatczuk.dev/projects/ typeof="ListItem">projects/</a></li><li><a href=https://michalmatczuk.dev/about/ typeof="ListItem">about/</a></li></ul></nav></div></div><div class="container animated zoomIn fast"><h1>ScyllaDB Manager 2.2: Repair Revisited</h1><p><em>This blog post has been first published in <a href=https://www.scylladb.com/author/mmatczuk/>ScyllaDB blog</a>.</em></p><p>We released ScyllaDB Manager 1.0 to help our users manage repairs in February 2018.
Since then a lot of things have changed.
We added the <a href=https://www.scylladb.com/2019/08/13/scylla-open-source-3-1-efficiently-maintaining-consistency-with-row-level-repair/>row-level repair</a> to ScyllaDB Open Source NoSQL Database, and to the Enterprise version this year.
We just released ScyllaDB Manager 2.2 with a new repair method optimized for row-level repair.</p><h2 id=new-repair-features-in-scylladb-manager-22>New repair features in ScyllaDB Manager 2.2</h2><h3 id=parallel-repairs>Parallel repairs</h3><p>ScyllaDB Manager chooses the optimal number of parallel repairs for a keyspace.
This is beneficial for big clusters.
For example, given a 12 node cluster and a keyspace with replication factor 3, it can be repaired up to 4 times faster than with ScyllaDB Manager 2.1.
This is done by repairing distinct replica sets in a token ring in parallel.
ScyllaDB Manager ensures that each node takes part in at most one ScyllaDB repair job at all times.</p><p>The following diagram shows a model of how token ranges are replicated in a token ring.</p><p><img src=Token-Ranges-and-Replication-2048x1804.png alt></p><p>Token ranges 11-20 are replicated by nodes N1, N2, N3.
When they are repaired we can still repair token ranges 41-50 replicated by nodes N4, N5, N6 and token ranges 71-80 replicated by nodes N7, N8, N9.
We could also repair ranges 101-110 on nodes N10, N11, and N0.
Otherwise Node N0 is idle; we can only repair token ranges 1-10 when nodes N1, N2 (and N3) are done repairing.
The process continues until the whole ring is repaired.</p><p>The parallel limit can be described by the following formula: <code>max_parallel = floor(# of nodes / keyspace RF)</code>.</p><p>In a multi DC setting the keyspace RF in the above formula is a sum of replication factors in different DCs.</p><h2 id=adjustment-of-repair-intensity-to-a-node-capabilities>Adjustment of repair intensity to a node capabilities</h2><p>Repair intensity feature was added in a previous version of ScyllaDB Manager.
It lets you specify how many token ranges (per shard) to repair in a single ScyllaDB repair job.
For ScyllaDB clusters that do not support row-level repair, intensity can also be a decimal between (0,1).
In that case it specifies percent of shards that can be repaired in parallel on a repair master node.</p><p>ScyllaDB Manager 2.2 adds support for <code>intensity=0</code>.
In that case the number of token ranges is calculated based on node memory and adjusted to the ScyllaDB maximal number of ranges that can be repaired in parallel (see <code>max_repair_ranges_in_parallel</code> in ScyllaDB logs).
If you want to repair faster, try setting <code>--intensity 0</code>.</p><h2 id=changing-the-repair-speed-in-flight>Changing the repair speed in flight</h2><p>In ScyllaDB Manager 2.2 we added two new sctool repair subcommands: <code>sctool repair update</code> and <code>sctool repair control</code>.
The former replaces the task update command and extends it with the capabilities to update any repair parameter in an existing repair task.
The latter allows you to change the intensity and parallelism as you repair without ever restarting the task.
In contrast to the update command the control command does not persist the changes for future runs.
The current values for intensity and parallel can be checked in <code>sctool task progress</code>.</p><p>Example:</p><p>Run the following command to adjust the number of token ranges per ScyllaDB repair job to the maximum supported (in parallel) by a repair master node.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sctool repair control -c prod-cluster --intensity <span class=m>0</span>
</span></span></code></pre></div><h2 id=support-for-schema-changes-during-repair>Support for schema changes during repair</h2><p>In ScyllaDB Manager 2.2 repair goes table by table.
This has many benefits.
On a node ScyllaDB repair jobs need to read fewer files, and we keep coming back to the same files before we move on to the next table.
When there is a new table added, it is not a concern of ScyllaDB Manager since the list of tables to repair is created in the repair init phase.
When a table is deleted during repair, ScyllaDB Manager gracefully handles that and moves on to the next table.</p><h2 id=small-table-optimization>Small table optimization</h2><p>Tables that contain less than 1G of data would be repaired in a few ScyllaDB repair jobs, one per replica set.
This saves time on ScyllaDB repair job creation and status checking.
The small table threshold can be changed as a repair command parameter.</p><h2 id=graceful-stop>Graceful stop</h2><p>Whenever a user decides to stop a repair there is a grace period to wait for the ongoing repair jobs before killing them.
The duration of the grace period by default is 30s, the default can be changed in the configuration file.</p><h2 id=new-sctool-repair-progress>New sctool repair progress</h2><p>Repair progress and duration is displayed per table.
In detailed view users may now see the actual repair progress of a keyspace or a table on each node.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>Status: DONE
</span></span><span class=line><span class=cl>Start time: <span class=m>12</span> Nov <span class=m>20</span> 13:17:26 CET
</span></span><span class=line><span class=cl>End time: <span class=m>12</span> Nov <span class=m>20</span> 13:21:11 CET
</span></span><span class=line><span class=cl>Duration: 3m45s
</span></span><span class=line><span class=cl>Progress: 100%
</span></span><span class=line><span class=cl>Datacenters:
</span></span><span class=line><span class=cl>- dc1
</span></span><span class=line><span class=cl>- dc2
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>╭───────────────┬────────┬──────────┬──────────╮
</span></span><span class=line><span class=cl>│ Keyspace.
</span></span><span class=line><span class=cl>    │ Table  │ Progress │ Duration │
</span></span><span class=line><span class=cl>├───────────────┼────────┼──────────┼──────────┤
</span></span><span class=line><span class=cl>│ test_keyspace │ data_0 │ 100%     │ 1m6s     │
</span></span><span class=line><span class=cl>│ test_keyspace │ data_1 │ 100%     │ 1m11s    │
</span></span><span class=line><span class=cl>│ test_keyspace │ data_2 │ 100%     │ 1m12s    │
</span></span><span class=line><span class=cl>│ test_keyspace │ data_3 │ 100%     │ 1m10s    │
</span></span><span class=line><span class=cl>│ test_keyspace │ data_4 │ 100%     │ 1m10s    │
</span></span><span class=line><span class=cl>│ test_keyspace │ data_5 │ 100%     │ 1m6s     │
</span></span><span class=line><span class=cl>│ test_keyspace │ data_6 │ 100%     │ 54s      │
</span></span><span class=line><span class=cl>│ test_keyspace │ data_7 │ 100%     │ 51s      │
</span></span><span class=line><span class=cl>│ test_keyspace │ data_8 │ 100%     │ 1s       │
</span></span><span class=line><span class=cl>│ test_keyspace │ data_9 │ 100%     │ 1s       │
</span></span><span class=line><span class=cl>╰───────────────┴────────┴──────────┴──────────╯
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>Host: 192.168.100.11
</span></span><span class=line><span class=cl>╭───────────────┬────────┬──────────┬──────────────┬─────────┬───────┬────────────────────────┬────────────────────────┬──────────╮
</span></span><span class=line><span class=cl>│ Keyspace      │ Table  │ Progress │ Token Ranges │ Success │ Error │             Started at <span class=p>|</span>           Completed at │ Duration │
</span></span><span class=line><span class=cl>├───────────────┼────────┼──────────┼──────────────┼─────────┼───────┼────────────────────────┼────────────────────────┼──────────┤
</span></span><span class=line><span class=cl>│ test_keyspace │ data_0 │     100% │          <span class=m>514</span> │     <span class=m>514</span> │     <span class=m>0</span> │ <span class=m>12</span> Nov <span class=m>20</span> 13:19:04 CET │ <span class=m>12</span> Nov <span class=m>20</span> 13:20:33 CET │      18s │
</span></span><span class=line><span class=cl>│ test_keyspace │ data_1 │     100% │          <span class=m>514</span> │     <span class=m>514</span> │     <span class=m>0</span> │ <span class=m>12</span> Nov <span class=m>20</span> 13:18:39 CET │ <span class=m>12</span> Nov <span class=m>20</span> 13:20:51 CET │      23s │
</span></span><span class=line><span class=cl>│ test_keyspace │ data_2 │     100% │          <span class=m>514</span> │     <span class=m>514</span> │     <span class=m>0</span> │ <span class=m>12</span> Nov <span class=m>20</span> 13:18:19 CET │ <span class=m>12</span> Nov <span class=m>20</span> 13:20:41 CET │      17s │
</span></span><span class=line><span class=cl>│ test_keyspace │ data_3 │     100% │          <span class=m>514</span> │     <span class=m>514</span> │     <span class=m>0</span> │ <span class=m>12</span> Nov <span class=m>20</span> 13:19:13 CET │ <span class=m>12</span> Nov <span class=m>20</span> 13:20:37 CET │      15s │
</span></span><span class=line><span class=cl>│ test_keyspace │ data_4 │     100% │          <span class=m>514</span> │     <span class=m>514</span> │     <span class=m>0</span> │ <span class=m>12</span> Nov <span class=m>20</span> 13:18:19 CET │ <span class=m>12</span> Nov <span class=m>20</span> 13:20:44 CET │      23s │
</span></span><span class=line><span class=cl>│ test_keyspace │ data_5 │     100% │          <span class=m>514</span> │     <span class=m>514</span> │     <span class=m>0</span> │ <span class=m>12</span> Nov <span class=m>20</span> 13:18:28 CET │ <span class=m>12</span> Nov <span class=m>20</span> 13:20:48 CET │      23s │
</span></span><span class=line><span class=cl>│ test_keyspace │ data_6 │     100% │          <span class=m>514</span> │     <span class=m>514</span> │     <span class=m>0</span> │ <span class=m>12</span> Nov <span class=m>20</span> 13:18:54 CET │ <span class=m>12</span> Nov <span class=m>20</span> 13:19:50 CET │      18s │
</span></span><span class=line><span class=cl>│ test_keyspace │ data_7 │     100% │          <span class=m>514</span> │     <span class=m>514</span> │     <span class=m>0</span> │ <span class=m>12</span> Nov <span class=m>20</span> 13:17:41 CET │ <span class=m>12</span> Nov <span class=m>20</span> 13:19:43 CET │      22s │
</span></span><span class=line><span class=cl>│ test_keyspace │ data_8 │     100% │          <span class=m>514</span> │     <span class=m>514</span> │     <span class=m>0</span> │ <span class=m>12</span> Nov <span class=m>20</span> 13:18:47 CET │ <span class=m>12</span> Nov <span class=m>20</span> 13:20:52 CET │       0s │
</span></span><span class=line><span class=cl>│ test_keyspace │ data_9 │     100% │          <span class=m>514</span> │     <span class=m>514</span> │     <span class=m>0</span> │ <span class=m>12</span> Nov <span class=m>20</span> 13:18:31 CET │ <span class=m>12</span> Nov <span class=m>20</span> 13:19:36 CET │       0s │
</span></span><span class=line><span class=cl>╰───────────────┴────────┴──────────┴──────────────┴─────────┴───────┴────────────────────────┴────────────────────────┴──────────╯
</span></span></code></pre></div><p>Benchmark</p><p>In the benchmark we run 9 ScyllaDB 2020.1 nodes on AWS i3.2xlarge machines.
Each node has 8 cores, 61GB of memory, and holds approximately 1.8TB of data.
During the tests the nodes are 50% loaded with a read workflow, and 10% of data needs to be repaired, all the nodes have missing data.
The following dashboard shows the system in the stabilisation phase before repair starts.</p><p><img src=scylla-monitoring-for-scylla-manager-2-2.png alt></p><p>The following chart presents effects of changing the parallel values between full parallelism (default), two parallel threads and one parallel thread.</p><p><img src=scylla-manager-performance-1.png alt></p><p>The following chart presents effects of changing intensity while running at full parallelism.
One can observe that when the system is loaded adding more repairs does not speed things up too much but it’s still in the range of 10%.</p><p><img src=scylla-manager-performance-2.png alt></p><p>If we take out parallel from the equation changing intensity from 1 (default) to 2 gives 20% improvement.
On an idle cluster intensity is more relevant.</p><p><img src=scylla-manager-performance-3.png alt></p><h2 id=summary>Summary</h2><p>ScyllaDB Manager 2.2’s parallel repair mechanism is a great supplement to ScyllaDB row-level repair.
Give it a try today! You can download it from the ScyllaDB Download Center.
Also, if you are interested in learning more about ScyllaDB Manager and repairs, check out <a href=https://university.scylladb.com/courses/scylla-operations/lessons/scylla-manager-repair-and-tombstones/>this free lesson</a> in ScyllaDB University!</p><div class=footer><a href=https://github.com/mmatczuk><i class="fa-brands fa-github"></i></a>
<a href=https://twitter.com/michalmatczuk><i class="fa-brands fa-twitter"></i></a>
<a href=https://www.linkedin.com/in/mmatczuk><i class="fa-brands fa-linkedin"></i></a></div></div></body></html>